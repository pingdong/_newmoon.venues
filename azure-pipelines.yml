resources:
  repositories:
  - repository: templates
    type: github
    name: pingdong/azure.devops.templates
    ref: refs/heads/master
    endpoint: GitHub

variables:
- name  : local#app.name
  value : Venues.FunctionApp
# Existing issue:
# A few value in deployment task, such as Pool:vmImage, environment, azureSubscription, 
#   are only read from stage-level variables or variable groups
#   https://github.com/microsoft/azure-pipelines-extensions/issues/832
# The root reason:
#   Azure DevOps need to check all permissions 
#   at the beginning of the run of the pipeline
- group: Deploy

trigger:
  batch: true

pr:
  autoCancel: true   # Cancel previous build if check in multiple times

schedules:
- cron: '0 1 * * *' # Every day at 1 A.M.
  displayName: Nightly Build
  branches:
    include:
    - master
  always: true      # Even no code change

stages:
# # Quality Control
# - stage: QualityControl
#   displayName: Quality Control
#   jobs:
#   - template: templates\test_static.yml@templates

#   - template: templates\test_unit.yml@templates
#     parameters:
#       appName: ${{ variables['local#app.name'] }}  # Can't use $(local@app.name) here
     
#   - template: templates\test_integration.yml@templates

# Build
- stage: Build
  displayName: Building
  # dependsOn: QualityControl
  condition: |
    and
    (
      succeeded(),
      eq(variables['Build.SourceBranch'], 'refs/heads/master'),
      ne(variables['Build.Reason'], 'Schedule')
    )
  jobs:
  - template: templates\build.yml@templates
    parameters:
      appName: ${{ variables['local#app.name'] }}
  
# Deployment
- stage: DeployToDev
  displayName: 'Deploying: DEV'
  dependsOn: Build
  variables:
  - group: Dev.Deploy
  jobs:
  - template: templates\deploy_functionapp.yml@templates
    parameters:
      vmImage: $(deploy#vmImage)
      environment: $(deploy#dev.environment)
      funcName: $(deploy#venue.app)
      azureSubscription: $(deploy#dev.azure.subscription)
 
- stage: DeployToProd
  displayName: 'Deploying: PROD'
  dependsOn: DeployToDev
  variables:
  - group: Prod.Deploy
  jobs:
  - template: templates\deploy_functionapp.yml@templates
    parameters:
      vmImage: $(deploy#vmImage)
      environment: $(deploy#prod.environment)
      funcName: $(deploy#venue.app)
      azureSubscription: $(deploy#prod.azure.subscription)
      enableSlot: true
      resourceGroupName: $(deploy#venue.resourcegroup)
      slotName: $(deploy#venue.app.slot)
      